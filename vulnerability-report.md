# Audit report for ECOM CupCakes shop based on OWASP assessment list

## A4 Insecure Direct object references
Always check whether the user identity matches with a requested resource identifier.

DO NOT do this:

```
public async Task<IActionResult> Details(string userId)
{
    var user = _context.Users.Where(u => u.ID == userId).ToListAsync()[0];
    return View(user);
}
```

DO THAT:

```
public async Task<IActionResult> Details(string userId)
{
    var user = _context.Users.Where(u => u.ID == userId).ToListAsync()[0];
    var userIdentityId = _userManager.GetUserId(Httpcontext.User);
    if(user.ID != userIdentityId)
        return NotFound();
    return View(user);
}
```

The ECOM project doesn't contain code where it looks for a user information based on the provided id. All methods in 'profile' section take current user from an identity storage using current HttpContext. It means that the treat is eliminated.

For example:

```
        public async Task OnGetAsync()
        {
            _user = await _userManager.GetUserAsync(HttpContext.User);
            Orders = await _order.GetOrders(_user.Id, 5);
        }
```

## A8 Cross site request forgery

Use anti-forgery token for any Post/Put requests from the Front-end.

Add to any form in a project Taghelpers or Htmlhelpers

```
<form>
    <div asp-validation-summary="All" class="text-danger"></div>
</form>
```
or
```
using (Html.BeginForm() {
    @Html.AntiForgeryToken()
}
```

Add on a server side special attribute - `[ValidateAntiForgeryToken]`. And remove all validation tokens on logout.

The project contains three forms along with corresponding controllers:

Account (to register/login a user);
Basket (for modifying quantity of products in a basket);
Checkout (to collect user address data);

Only Account contorller and forms have antiforgery attributes/validation. Both Basket and Checkout are vulnurable to CSRF attack. Suggestion: add validation to all forms/controllers.